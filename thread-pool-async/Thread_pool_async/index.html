<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Thread_pool_async (thread-pool-async.Thread_pool_async)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">thread-pool-async</a> &#x00BB; Thread_pool_async</nav><h1>Module <code>Thread_pool_async</code></h1></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> 'state t</code></dt><dd><p>A thread pool.</p></dd></dl><dl><dt class="spec type" id="type-worker"><a href="#type-worker" class="anchor"></a><code><span class="keyword">type</span> 'state worker</code></dt><dd><p>A single worker thread within the pool.</p></dd></dl><dl><dt class="spec exception" id="exception-Invalid_thread_count"><a href="#exception-Invalid_thread_count" class="anchor"></a><code><span class="keyword">exception</span> </code><code><span class="exception">Invalid_thread_count</span> <span class="keyword">of</span> int</code></dt><dd><p>Raised if the pool is initiated with a non-positive thread count.</p></dd></dl><dl><dt class="spec exception" id="exception-Pool_already_destroyed"><a href="#exception-Pool_already_destroyed" class="anchor"></a><code><span class="keyword">exception</span> </code><code><span class="exception">Pool_already_destroyed</span></code></dt><dd><p>Raised if the pool is used after it has been destroyed.</p></dd></dl><dl><dt class="spec exception" id="exception-State_manipulation_error"><a href="#exception-State_manipulation_error" class="anchor"></a><code><span class="keyword">exception</span> </code><code><span class="exception">State_manipulation_error</span> <span class="keyword">of</span> exn</code></dt><dd><p>Raised if the creation or destruction of the piece of state state associated with a worker thread raises an exception.</p><p>When this exception is raised, the whole pool is already destroyed. In order to execute any additional work, a new pool needs to be initialized first.</p></dd></dl><dl><dt class="spec value" id="val-init"><a href="#val-init" class="anchor"></a><code><span class="keyword">val</span> init : name:string <span>&#45;&gt;</span> threads:int <span>&#45;&gt;</span> create:(unit <span>&#45;&gt;</span> <span class="type-var">'state</span>) <span>&#45;&gt;</span> destroy:(<span class="type-var">'state</span> <span>&#45;&gt;</span> unit) <span>&#45;&gt;</span> <span class="type-var">'state</span> <a href="index.html#type-t">t</a> Async_kernel.Deferred.t</code></dt><dd><p>Initializes a pool. The same name is used for all the threads in the pool. Each worker thread also has an associated piece of state. The `create` function initializes the state while the `destroy` function cleans it up.</p></dd></dl><dl><dt class="spec value" id="val-with'"><a href="#val-with'" class="anchor"></a><code><span class="keyword">val</span> with' : <span class="type-var">'state</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> ?&#8288;retries:int <span>&#45;&gt;</span> (<span class="type-var">'state</span> <span>&#45;&gt;</span> (<span class="type-var">'value</span>, <span class="type-var">'error</span>) Stdlib.result) <span>&#45;&gt;</span> (<span class="type-var">'value</span>, <span class="type-var">'error</span>) Async_kernel.Deferred.Result.t</code></dt><dd><p>Runs a piece of work on the first available thread in the pool.</p><p>If the supplied function returns an error, then `retries` specifies the maximum number of times that the function is re-run. All retries are guaranteed to be on the same thread. If retries are exhausted without a successful execution, then the last encountered error is returned.</p><p>If the supplied function raises an exception, then that exception will be raised to the monitor that called `with'`.</p><p>Whenever the supplied function returns an error or throws an exception, the state associated with the executing thread is cleaned up and a new piece of state is created to replace it.</p><p>WARNING: Async code MUST NOT be used in the work callback. This encompasses pretty much all functions of libraries making use of Async. Only a few functions of the Async library can be called. These are explicitly marked as such, using the phrase &quot;thread-safe&quot;.</p></dd></dl><dl><dt class="spec value" id="val-with_worker"><a href="#val-with_worker" class="anchor"></a><code><span class="keyword">val</span> with_worker : <span class="type-var">'state</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> ?&#8288;retries:int <span>&#45;&gt;</span> (<span class="type-var">'state</span> <a href="index.html#type-worker">worker</a> <span>&#45;&gt;</span> (<span class="type-var">'value</span>, <span class="type-var">'error</span>) Async_kernel.Deferred.Result.t) <span>&#45;&gt;</span> (<span class="type-var">'value</span>, <span class="type-var">'error</span>) Async_kernel.Deferred.Result.t</code></dt><dd><p>Reserves a worker thread and runs a function that can use the Async scheduler as well as the worker thread to do its job.</p><p>If the supplied function results in an error, then `retries` specifies the maximum number of times that the function is re-run. All retries are guaranteed to be on the same thread. If retries are exhausted without a successful execution, then the last encountered error is returned.</p><p>If the supplied function raises an exception, then that exception will be raised to the monitor that called `with_worker`.</p><p>Whenever the supplied function results in an error or throws an exception, the state associated with the executing thread is cleaned up and a new piece of state is created to replace it.</p></dd></dl><dl><dt class="spec value" id="val-execute"><a href="#val-execute" class="anchor"></a><code><span class="keyword">val</span> execute : <span class="type-var">'state</span> <a href="index.html#type-worker">worker</a> <span>&#45;&gt;</span> (<span class="type-var">'state</span> <span>&#45;&gt;</span> <span class="type-var">'outcome</span>) <span>&#45;&gt;</span> <span class="type-var">'outcome</span> Async_kernel.Deferred.t</code></dt><dd><p>Executes the supplied function inside the specified worker thread.</p><p>If the supplied function raises an exception, then that exception will be raised to the monitor that called `execute`.</p><p>Note that the state associated with the executing worker thread is never cleaned up or replaced by this function.</p><p>WARNING: Async code MUST NOT be used in the supplied function. This encompasses pretty much all functions of libraries making use of Async. Only a few functions of the Async library can be called. These are explicitly marked as such, using the phrase &quot;thread-safe&quot;.</p></dd></dl><dl><dt class="spec value" id="val-destroy"><a href="#val-destroy" class="anchor"></a><code><span class="keyword">val</span> destroy : <span class="type-var">'state</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> unit Async_kernel.Deferred.t</code></dt><dd><p>Frees up all worker threads in the pool as well as the state associated with them.</p></dd></dl></div></body></html>